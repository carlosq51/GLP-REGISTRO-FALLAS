<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>Uploader GLP</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; padding: 16px; max-width: 760px; margin: 0 auto; }
    .row { margin: 10px 0; }
    .box { border: 1px solid #ddd; padding: 12px; border-radius: 10px; margin: 10px 0; }
    label { display:block; font-weight:600; margin-bottom:6px; }
    input[type="text"], input[type="date"], textarea { width: 100%; padding: 10px; border: 1px solid #bbb; border-radius: 10px; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; }
    .btn { background: #0b5fff; color: white; }
    .btn2 { background: #111; color: white; }
    .btn3 { background: #eee; color: #111; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .small { color: #555; font-size: 12px; }
    .status { white-space: pre-wrap; background: #f6f6f6; padding: 12px; border-radius: 10px; }
    .qrReader { width: 100%; }

    .slotCard{ border:1px solid #e5e5e5; border-radius:12px; padding:12px; background:#fff; }
    .slotActions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .slotActions button{ padding:8px 10px; border-radius:10px; font-size:14px; }
    .mini{ margin-top:10px; display:flex; gap:10px; align-items:center; }
    .thumb{
      width:84px; height:84px; border-radius:12px; border:1px solid #ddd;
      background:#fafafa; display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .miniInfo{ font-size:12px; color:#444; }
    .hiddenInput{ display:none; }

    /* ====== NUEVO: PANTALLAS ====== */
    .screen{ display:none; }
    .screen.active{ display:block; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin: 8px 0 14px;
    }
    .topbar h2, .topbar h3{ margin:0; }
    .menuGrid{
      display:grid; gap:12px;
      grid-template-columns: 1fr;
    }
    .menuCard{
      border:1px solid #e5e5e5; border-radius:14px; padding:14px;
      background:#fff;
    }
    .menuTitle{ font-weight:800; font-size:18px; margin:0 0 4px; }
    .menuDesc{ margin:0; color:#555; font-size:13px; }
    .menuCard .btn{ width:100%; margin-top:10px; }
    textarea{ min-height: 90px; resize: vertical; }

    /* ‚úÖ BOT√ìN PRINCIPAL: SUBIR FOTOS */
    .btnPrimaryBig{
      width: 100%;
      max-width: 520px;
      display: block;
      margin: 18px auto 6px;
      padding: 18px 18px;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .4px;
      background: #12b76a; /* verde f√°cil de identificar */
      color: #fff;
      box-shadow: 0 10px 24px rgba(18,183,106,.30);
      transition: transform .08s ease, filter .12s ease;
    }
    .btnPrimaryBig:active{ transform: scale(.99); filter: brightness(.95); }
    .btnPrimaryBig:disabled{ opacity: .55; cursor: not-allowed; }

    /* ‚úÖ MODAL IMAGEN FULLSCREEN */
    .imgModal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.92);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }
    .imgModal.open{ display:flex; }
    .imgModal img{
      max-width: 100%;
      max-height: 100%;
      border-radius: 14px;
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
    }
    .imgModalClose{
      position: fixed;
      top: 14px;
      right: 14px;
      width: 46px;
      height: 46px;
      border-radius: 999px;
      background: rgba(255,255,255,.14);
      color: #fff;
      font-size: 20px;
      font-weight: 900;
      border: 1px solid rgba(255,255,255,.22);
      cursor: pointer;
    }
  </style>
</head>

<body>

  <!-- =========================
       PANTALLA 0: MEN√ö INICIAL
       ========================= -->
  <section id="screenMenu" class="screen active">
    <div class="topbar">
      <h2>Uploader GLP</h2>
      <span class="small">Selecciona una opci√≥n</span>
    </div>

    <div class="menuGrid">
      <div class="menuCard">
        <p class="menuTitle">Registrar par√°metros</p>
        <p class="menuDesc">Sube las 9 fotos (VIN, COMPRESI√ìN, AMPERAJE, VOLTAJE, SCANNER).</p>
        <button class="btn" id="goParams">Entrar</button>
      </div>

      <div class="menuCard">
        <p class="menuTitle">Registrar falla</p>
        <p class="menuDesc">Registra una falla con nota.</p>
        <button class="btn" id="goFalla">Entrar</button>
      </div>

      <div class="menuCard">
        <p class="menuTitle">Control calidad</p>
        <p class="menuDesc">Pantalla de control de calidad.</p>
        <button class="btn" id="goCalidad">Entrar</button>
      </div>
    </div>

    <div class="box" style="margin-top:14px;">
      <div class="small"></div>
    </div>
  </section>

  <!-- =========================
       PANTALLA 1: REGISTRAR PAR√ÅMETROS
       ========================= -->
  <section id="screenParams" class="screen">
    <div class="topbar">
      <h2>Registrar par√°metros</h2>
      <button class="btn3" type="button" data-nav="menu">‚¨Ö Volver</button>
    </div>

    <div class="box">
      <div class="row">
        <button class="btn" id="btnScanQR_params">Escanear QR</button>
        <button class="btn" id="btnScanBAR_params">Escanear CODIGO BARRAS</button>
        <button class="btn3" id="btnStop_params" style="display:none;">Detener</button>
        <div class="small" id="scanMsg_params"></div>
      </div>

      <div id="qrBox_params" style="display:none; margin-top:10px;">
        <div class="small" id="scanMode_params" style="margin-bottom:8px;"></div>
        <div id="qrReader_params" class="qrReader"></div>
        <div class="small" style="margin-top:8px;">
          Tip: en BARRAS apunta con buena luz y ocupa casi todo el ancho del recuadro.
        </div>
      </div>

      <div class="row">
        <label>VIN (texto)</label>
        <input id="vinText" type="text" placeholder="Escanea o escribe VIN..." />
      </div>

      <div class="row">
        <label>Fecha (YYYY-MM-DD)</label>
        <input id="dateStr" type="date" />
        <div class="small">Si no eliges fecha, usa la de hoy.</div>
      </div>

      <div class="row">
        <button class="btn3" id="btnRefresh">Refrescar estado</button>
      </div>
    </div>

    <h3>Fotos (9) ‚Äî se guardan en Drive</h3>

    <div class="box grid">
      <!-- 1) VIN -->
      <div class="slotCard" data-slot="vin">
        <label>1) Foto del VIN</label>

        <!-- ‚úÖ IDs CORRECTOS (no duplicados) -->
        <input class="hiddenInput" type="file" accept="image/*;capture=camera" capture="environment" id="vin_cam">
        <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" id="vin_file">

        <div class="slotActions">
          <button class="btn3" type="button" data-pick="cam" data-slot="vin">üì∑ Tomar foto</button>
          <button class="btn3" type="button" data-pick="file" data-slot="vin">üñºÔ∏è Subir archivo</button>
          <button class="btn3" type="button" data-clear="1" data-slot="vin">üßπ Quitar</button>
        </div>

        <div class="mini">
          <div class="thumb" id="vin_previewBox"><span class="small">Sin foto</span></div>
          <div class="miniInfo" id="vin_meta">Ning√∫n archivo seleccionado.</div>
        </div>
      </div>

      <!-- 2) COMPRESI√ìN: 4 fotos -->
      <div class="slotCard" data-slot="comp">
        <label>2) Compresi√≥n (toma 4 fotos)</label>

        <input class="hiddenInput" type="file" accept="image/*;capture=camera" capture="environment" id="comp_cam">
        <!-- ‚úÖ multiple para seleccionar varias desde archivos -->
        <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" id="comp_file" multiple>

        <div class="slotActions">
          <button class="btn3" type="button" data-pick="cam" data-slot="comp">üì∑ Tomar foto (agrega)</button>
          <button class="btn3" type="button" data-pick="file" data-slot="comp">üñºÔ∏è Subir archivo (agrega)</button>
          <button class="btn3" type="button" data-clear="1" data-slot="comp">üßπ Quitar todas</button>
        </div>

        <div class="grid" style="grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:10px;">
          <div class="thumb" id="comp_p1"><span class="small">1</span></div>
          <div class="thumb" id="comp_p2"><span class="small">2</span></div>
          <div class="thumb" id="comp_p3"><span class="small">3</span></div>
          <div class="thumb" id="comp_p4"><span class="small">4</span></div>
        </div>

        <div class="miniInfo" id="comp_meta" style="margin-top:10px;">
          Ning√∫n archivo seleccionado.
        </div>
      </div>

      <!-- 6) Corriente antes -->
      <div class="slotCard" data-slot="corr_pre">
        <label>6) Amperaje antes</label>

        <input class="hiddenInput" type="file" accept="image/*;capture=camera" capture="environment" id="corr_pre_cam">
        <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" id="corr_pre_file">

        <div class="slotActions">
          <button class="btn3" type="button" data-pick="cam" data-slot="corr_pre">üì∑ Tomar foto</button>
          <button class="btn3" type="button" data-pick="file" data-slot="corr_pre">üñºÔ∏è Subir archivo</button>
          <button class="btn3" type="button" data-clear="1" data-slot="corr_pre">üßπ Quitar</button>
        </div>

        <div class="mini">
          <div class="thumb" id="corr_pre_previewBox"><span class="small">Sin foto</span></div>
          <div class="miniInfo" id="corr_pre_meta">Ning√∫n archivo seleccionado.</div>
        </div>
      </div>

      <!-- 7) Corriente despu√©s -->
      <div class="slotCard" data-slot="corr_post">
        <label>7) Amperaje despu√©s</label>

        <input class="hiddenInput" type="file" accept="image/*;capture=camera" capture="environment" id="corr_post_cam">
        <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" id="corr_post_file">

        <div class="slotActions">
          <button class="btn3" type="button" data-pick="cam" data-slot="corr_post">üì∑ Tomar foto</button>
          <button class="btn3" type="button" data-pick="file" data-slot="corr_post">üñºÔ∏è Subir archivo</button>
          <button class="btn3" type="button" data-clear="1" data-slot="corr_post">üßπ Quitar</button>
        </div>

        <div class="mini">
          <div class="thumb" id="corr_post_previewBox"><span class="small">Sin foto</span></div>
          <div class="miniInfo" id="corr_post_meta">Ning√∫n archivo seleccionado.</div>
        </div>
      </div>

      <!-- 8) Voltaje -->
      <div class="slotCard" data-slot="voltaje">
        <label>8) Voltaje</label>

        <input class="hiddenInput" type="file" accept="image/*;capture=camera" capture="environment" id="voltaje_cam">
        <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" id="voltaje_file">

        <div class="slotActions">
          <button class="btn3" type="button" data-pick="cam" data-slot="voltaje">üì∑ Tomar foto</button>
          <button class="btn3" type="button" data-pick="file" data-slot="voltaje">üñºÔ∏è Subir archivo</button>
          <button class="btn3" type="button" data-clear="1" data-slot="voltaje">üßπ Quitar</button>
        </div>

        <div class="mini">
          <div class="thumb" id="voltaje_previewBox"><span class="small">Sin foto</span></div>
          <div class="miniInfo" id="voltaje_meta">Ning√∫n archivo seleccionado.</div>
        </div>
      </div>

      <!-- 9) Scan del carro -->
      <div class="slotCard" data-slot="scan_carro">
        <label>9) Scan del carro</label>

        <input class="hiddenInput" type="file" accept="image/*;capture=camera" capture="environment" id="scan_carro_cam">
        <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" id="scan_carro_file">

        <div class="slotActions">
          <button class="btn3" type="button" data-pick="cam" data-slot="scan_carro">üì∑ Tomar foto</button>
          <button class="btn3" type="button" data-pick="file" data-slot="scan_carro">üñºÔ∏è Subir archivo</button>
          <button class="btn3" type="button" data-clear="1" data-slot="scan_carro">üßπ Quitar</button>
        </div>

        <div class="mini">
          <div class="thumb" id="scan_carro_previewBox"><span class="small">Sin foto</span></div>
          <div class="miniInfo" id="scan_carro_meta">Ning√∫n archivo seleccionado.</div>
        </div>
      </div>
    </div>

    <div class="row">
      <button class="btnPrimaryBig" id="btnUpload">‚¨ÜÔ∏è SUBIR FOTOS</button>
    </div>

    <h3>Estado colaborativo</h3>
    <div id="out" class="status">Listo.</div>
  </section>

  <!-- =========================
       PANTALLA 2: REGISTRAR FALLA
       ========================= -->
  <section id="screenFalla" class="screen">
    <div class="topbar">
      <h2>Registrar falla</h2>
      <button class="btn3" type="button" data-nav="menu">‚¨Ö Volver</button>
    </div>

    <div class="box">
      <div class="row">
        <button class="btn" id="btnScanQR_falla">Escanear SOLO QR</button>
        <button class="btn" id="btnScanBAR_falla">Escanear SOLO BARRAS</button>
        <button class="btn3" id="btnStop_falla" style="display:none;">Detener</button>
        <div class="small" id="scanMsg_falla"></div>
      </div>

      <div id="qrBox_falla" style="display:none; margin-top:10px;">
        <div class="small" id="scanMode_falla" style="margin-bottom:8px;"></div>
        <div id="qrReader_falla" class="qrReader"></div>
        <div class="small" style="margin-top:8px;">
          Tip: en BARRAS apunta con buena luz y ocupa casi todo el ancho del recuadro.
        </div>
      </div>

      <div class="row">
        <label>VIN</label>
        <input id="fallaVin" type="text" placeholder="Escribe o pega VIN..." />
        <div class="small">Tip: puedes copiarlo desde ‚ÄúRegistrar par√°metros‚Äù.</div>
      </div>

      <div class="row">
        <label>Fecha</label>
        <input id="fallaDate" type="date" />
      </div>

      <div class="row">
        <label>Descripci√≥n / Nota</label>
        <textarea id="fallaNota" placeholder="Describe la falla..."></textarea>
      </div>

      <div class="row">
        <label>Fotos de falla (sin l√≠mite)</label>

        <input class="hiddenInput" type="file" accept="image/*;capture=camera" capture="environment" id="falla_cam">
        <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" id="falla_file" multiple>

        <div class="slotActions">
          <button class="btn3" type="button" id="btnFallaCam">üì∑ Tomar foto (agrega)</button>
          <button class="btn3" type="button" id="btnFallaFile">üñºÔ∏è Subir archivo(s) (agrega)</button>
          <button class="btn3" type="button" id="btnFallaClear">üßπ Quitar todas</button>
        </div>

        <div class="grid" id="fallaGrid" style="grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:10px;"></div>
        <div class="small" id="fallaFotosMeta">0 archivo(s).</div>
      </div>

      <div class="row">
        <button class="btn2" id="btnEnviarFalla">ENVIAR FALLA</button>
      </div>

      <div class="small">
        Nota: esta pantalla est√° lista. Si quieres, la conecto a tu Apps Script con un action tipo <b>uploadFalla</b>
        que cree carpeta <b>CHASIS-FECHA/FALLAS</b> y suba todo ah√≠.
      </div>
    </div>

    <div id="outFalla" class="status">Listo.</div>
  </section>

  <!-- =========================
       PANTALLA 3: CONTROL CALIDAD
       ========================= -->
  <section id="screenCalidad" class="screen">
    <div class="topbar">
      <h2>Control calidad</h2>
      <button class="btn3" type="button" data-nav="menu">‚¨Ö Volver</button>
    </div>

    <div class="box">
      <div class="row">
        <button class="btn" id="btnScanQR_qc">Escanear SOLO QR</button>
        <button class="btn" id="btnScanBAR_qc">Escanear SOLO BARRAS</button>
        <button class="btn3" id="btnStop_qc" style="display:none;">Detener</button>
        <div class="small" id="scanMsg_qc"></div>
      </div>

      <div id="qrBox_qc" style="display:none; margin-top:10px;">
        <div class="small" id="scanMode_qc" style="margin-bottom:8px;"></div>
        <div id="qrReader_qc" class="qrReader"></div>
        <div class="small" style="margin-top:8px;">
          Tip: en BARRAS apunta con buena luz y ocupa casi todo el ancho del recuadro.
        </div>
      </div>

      <div class="row">
        <label>VIN</label>
        <input id="qcVin" type="text" placeholder="VIN..." />
      </div>

      <div class="row">
        <label>Fecha</label>
        <input id="qcDate" type="date" />
      </div>

      <div class="slotCard" style="margin-top:10px;">
        <label>Fotos de Calidad (m√≠n 3, m√°x 4)</label>

        <input class="hiddenInput" type="file" accept="image/*;capture=camera" capture="environment" id="qc_cam">
        <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" id="qc_file" multiple>

        <div class="slotActions">
          <button class="btn3" type="button" id="btnQcCam">üì∑ Tomar foto (agrega)</button>
          <button class="btn3" type="button" id="btnQcFile">üñºÔ∏è Subir archivo (agrega)</button>
          <button class="btn3" type="button" id="btnQcClear">üßπ Quitar todas</button>
        </div>

        <div class="grid" style="grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:10px;">
          <div class="thumb" id="qc_p1"><span class="small">1</span></div>
          <div class="thumb" id="qc_p2"><span class="small">2</span></div>
          <div class="thumb" id="qc_p3"><span class="small">3</span></div>
          <div class="thumb" id="qc_p4"><span class="small">4</span></div>
        </div>

        <div class="miniInfo" id="qc_meta" style="margin-top:10px;">0/4 seleccionadas.</div>
      </div>

      <div class="row">
        <button class="btnPrimaryBig" id="btnQcUpload">‚¨ÜÔ∏è ENVIAR CALIDAD</button>
      </div>
    </div>

    <div id="outQc" class="status">Listo.</div>
  </section>

  <!-- ‚úÖ VISOR FULLSCREEN (LIGHTBOX) -->
  <div id="imgModal" class="imgModal" aria-hidden="true">
    <button type="button" class="imgModalClose" id="imgModalClose">‚úï</button>
    <img id="imgModalImg" alt="Vista completa" />
  </div>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    const APS_URL = "https://script.google.com/macros/s/AKfycbw8WdoYVKGU9ztmHv81c-GzcUxpaCdMn5mvk5XgqJQ7kicbivdr6DFRIgTEOq_nIUMV/exec";
    const $ = (id) => document.getElementById(id);

    // ‚úÖ LIGHTBOX FULLSCREEN (sirve para previews locales y de Drive)
    const imgModal = $("imgModal");
    const imgModalImg = $("imgModalImg");
    const imgModalClose = $("imgModalClose");

    function openImageModal(src){
      if (!imgModal || !imgModalImg || !src) return;
      imgModalImg.src = src;
      imgModal.classList.add("open");
      imgModal.setAttribute("aria-hidden", "false");
    }

    function closeImageModal(){
      if (!imgModal || !imgModalImg) return;
      imgModal.classList.remove("open");
      imgModalImg.src = "";
      imgModal.setAttribute("aria-hidden", "true");
    }

    if (imgModal) {
      imgModal.addEventListener("click", (e) => {
        if (e.target === imgModal) closeImageModal();
      });
    }
    if (imgModalClose) imgModalClose.onclick = closeImageModal;

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeImageModal();
    });

    document.addEventListener("click", (e) => {
      const img = e.target && e.target.closest && e.target.closest(".thumb img");
      if (!img) return;
      openImageModal(img.currentSrc || img.src);
    });

    // =========================
    // ‚úÖ NAV ENTRE PANTALLAS
    // =========================
    const screens = {
      menu: $("screenMenu"),
      params: $("screenParams"),
      falla: $("screenFalla"),
      calidad: $("screenCalidad")
    };

    function showScreen(name){
      Object.values(screens).forEach(s => s.classList.remove("active"));
      const el = screens[name];
      if (el) el.classList.add("active");
      try { stopAllScanners(); } catch {}
    }

    $("goParams").onclick = () => showScreen("params");
    $("goFalla").onclick  = () => {
      const vin = $("vinText")?.value?.trim() || "";
      if (vin) $("fallaVin").value = vin;
      $("fallaDate").value = ($("dateStr")?.value || todayYYYYMMDD());
      showScreen("falla");
    };
    $("goCalidad").onclick = () => {
      const vin = $("vinText")?.value?.trim() || "";
      if (vin) $("qcVin").value = vin;
      $("qcDate").value = ($("dateStr")?.value || todayYYYYMMDD());
      showScreen("calidad");
    };

    document.addEventListener("click", (ev) => {
      const b = ev.target.closest("button");
      if (!b) return;
      const nav = b.getAttribute("data-nav");
      if (nav === "menu") showScreen("menu");
    });

    // =========================
    // (Tu helper original)
    // =========================
    const slotLabels = {
      vin: "Foto del VIN",
      comp_1: "Compresi√≥n",
      comp_2: "Compresi√≥n",
      comp_3: "Compresi√≥n",
      comp_4: "Compresi√≥n",
      corr_pre: "Corriente antes",
      corr_post: "Corriente despu√©s",
      voltaje: "Voltaje",
      scan_carro: "Scan del carro",
    };

    const slots = ["vin","comp_1","comp_2","comp_3","comp_4","corr_pre","corr_post","voltaje","scan_carro"];
    const selectedFilesBySlot = {};

    let compFilesVisual = [null, null, null, null];

    function todayYYYYMMDD() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function getQueryParam(name){
  try{
    return new URLSearchParams(window.location.search).get(name) || "";
  } catch {
    return "";
  }
}

function applyVinFromUrl(){
  const vin = (getQueryParam("vin") || getQueryParam("VIN") || "").trim();
  if (!vin) return;

  // set en las 3 pantallas
  if ($("vinText"))  $("vinText").value = vin;
  if ($("fallaVin")) $("fallaVin").value = vin;
  if ($("qcVin"))    $("qcVin").value = vin;

  // fecha opcional por URL
  const dateStr = (getQueryParam("date") || getQueryParam("fecha") || "").trim();
  if (dateStr){
    if ($("dateStr"))   $("dateStr").value = dateStr;
    if ($("fallaDate")) $("fallaDate").value = dateStr;
    if ($("qcDate"))    $("qcDate").value = dateStr;
  }

  // pantalla opcional por URL
  const pantalla = (getQueryParam("pantalla") || getQueryParam("screen") || "").toLowerCase();
  if (pantalla === "params") showScreen("params");
  if (pantalla === "falla")  showScreen("falla");
  if (pantalla === "calidad" || pantalla === "qc") showScreen("calidad");

  // refresca estado si estamos en params
  try { refreshStatus(); } catch {}
}

// correr al cargar
applyVinFromUrl();

    
    (function initDate(){
      $("dateStr").value = todayYYYYMMDD();
      $("fallaDate").value = todayYYYYMMDD();
    })();

    async function callAPS(payload){
      const res = await fetch(APS_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });
      return res.json();
    }

    function humanBytes(n){
      const u = ["B","KB","MB","GB"];
      let i=0, v=n;
      while(v>=1024 && i<u.length-1){ v/=1024; i++; }
      return `${v.toFixed(i===0?0:1)} ${u[i]}`;
    }

    function setPreview(slot, file){
      const box = $(`${slot}_previewBox`);
      const meta = $(`${slot}_meta`);
      if (!box || !meta) return;

      if (!file){
        box.innerHTML = `<span class="small">Sin foto</span>`;
        meta.textContent = "Ning√∫n archivo seleccionado.";
        return;
      }
      meta.textContent = `${file.name || "(foto)"} ‚Ä¢ ${humanBytes(file.size || 0)}`;
      const url = URL.createObjectURL(file);
      box.innerHTML = `<img alt="preview" src="${url}">`;
      setTimeout(() => URL.revokeObjectURL(url), 15000);
    }

    function setRemotePreview(slot, p){
      const box = $(`${slot}_previewBox`);
      const meta = $(`${slot}_meta`);
      if (!box || !meta || !p) return;

      const src1 = p.thumbUrl || "";
      const src2 = p.imgUrl || "";

      meta.textContent = "üì° Ya existe en Drive (preview).";

      box.innerHTML = `
        <img id="${slot}_img"
             alt="drive preview"
             src="${src1 || src2}"
             loading="lazy"
             referrerpolicy="no-referrer"
             style="width:100%;height:100%;object-fit:cover;display:block;">
      `;

      const im = document.getElementById(`${slot}_img`);
      if (!im) return;

      im.onerror = () => {
        if (src2 && im.src !== src2) im.src = src2;
        else box.innerHTML = `<span class="small">No se pudo cargar preview</span>`;
      };
    }

    function setRemoteCompPreview(idx1to4, p){
      const box = $(`comp_p${idx1to4}`);
      if (!box || !p) return;

      const src1 = p.thumbUrl || "";
      const src2 = p.imgUrl || "";

      box.innerHTML = `
        <img id="comp_img_${idx1to4}"
             alt="drive preview"
             src="${src1 || src2}"
             loading="lazy"
             referrerpolicy="no-referrer"
             style="width:100%;height:100%;object-fit:cover;display:block;">
      `;

      const im = document.getElementById(`comp_img_${idx1to4}`);
      if (!im) return;

      im.onerror = () => {
        if (src2 && im.src !== src2) im.src = src2;
        else box.innerHTML = `<span class="small">${idx1to4}</span>`;
      };
    }

    // ====== COMPRESI√ìN ======
    function clearComp(){
      compFilesVisual = [null, null, null, null];
      ["comp_p1","comp_p2","comp_p3","comp_p4"].forEach((id, idx) => {
        $(id).innerHTML = `<span class="small">${idx+1}</span>`;
      });
      $("comp_meta").textContent = "Ning√∫n archivo seleccionado.";
      const cam = $("comp_cam"); const fil = $("comp_file");
      if (cam) cam.value = "";
      if (fil) fil.value = "";
    }

    function renderCompPreviews(){
      const ids = ["comp_p1","comp_p2","comp_p3","comp_p4"];
      ids.forEach((id, idx) => {
        const box = $(id);
        const f = compFilesVisual[idx];
        if (!f){
          box.innerHTML = `<span class="small">${idx+1}</span>`;
          return;
        }
        const url = URL.createObjectURL(f);
        box.innerHTML = `<img alt="preview" src="${url}">`;
        setTimeout(() => URL.revokeObjectURL(url), 15000);
      });

      const chosen = compFilesVisual.filter(Boolean);
      if (!chosen.length) $("comp_meta").textContent = "Ning√∫n archivo seleccionado.";
      else {
        const totalSize = chosen.reduce((a,f)=>a+(f.size||0),0);
        $("comp_meta").textContent = `${chosen.length}/4 seleccionadas ‚Ä¢ ${humanBytes(totalSize)} (entra al 4 y empuja atr√°s)`;
      }
    }

    function addCompOne(file){
      if (!file) return;
      compFilesVisual[0] = compFilesVisual[1];
      compFilesVisual[1] = compFilesVisual[2];
      compFilesVisual[2] = compFilesVisual[3];
      compFilesVisual[3] = file;
      renderCompPreviews();
    }

    function onPickCompCam(fileList){
      const f = (fileList && fileList[0]) ? fileList[0] : null;
      if (!f) return;
      addCompOne(f);
      $("comp_cam").value = "";
    }

    function onPickCompFiles(fileList){
      const arr = Array.from(fileList || []);
      if (!arr.length) return;
      const take = arr.slice(-4);
      for (const f of take) addCompOne(f);
      $("comp_file").value = "";
    }

    (function wireComp(){
      clearComp();
      $("comp_cam").addEventListener("change", (e) => onPickCompCam(e.target.files));
      $("comp_file").addEventListener("change", (e) => onPickCompFiles(e.target.files));
    })();

    // ====== STATUS ======
    function renderStatus(j){
      let s = "";
      s += `VIN: ${j.vin}\n`;
      s += `Fecha: ${j.dateStr}\n`;
      s += `Carpeta: ${j.monthFolderName} / ${j.carFolderName} / REGISTRO\n\n`;

      const compSlots = ["comp_1","comp_2","comp_3","comp_4"];
      const compOkCount = compSlots.filter(sl => j.status && j.status[sl]).length;
      const compMissingCount = 4 - compOkCount;

      s += `${compOkCount === 4 ? "‚úÖ" : "‚ùå"} Compresi√≥n (${compOkCount}/4)\n`;
      if (compMissingCount > 0) s += `   Faltan: ${compMissingCount} foto(s)\n`;

      const otherSlots = ["vin","corr_pre","corr_post","voltaje","scan_carro"];
      let missing = [];
      for (const slot of otherSlots){
        const ok = j.status && j.status[slot];
        const p = j.previews && j.previews[slot];
        s += `${ok ? "‚úÖ" : "‚ùå"} ${slotLabels[slot]}`;
        if (p && p.url) s += `  (ver: ${p.url})`;
        s += "\n";
        if (!ok) missing.push(slotLabels[slot]);
      }

      const allMissingCount = compMissingCount + missing.length;
      s += `\nFaltantes (${allMissingCount}/9):\n- ` + (allMissingCount ? ["Compresi√≥n ("+compOkCount+"/4)", ...missing].join("\n- ") : "Ninguno üéâ");
      $("out").textContent = s;
    }

    async function refreshStatus(){
      const vin = $("vinText").value.trim();
      const dateStr = ($("dateStr").value || todayYYYYMMDD());
      if (!vin) { $("out").textContent = "‚ùå Falta VIN (texto)."; return; }

      const j = await callAPS({ action: "getStatus", vin, dateStr });
      if (!j.ok) { $("out").textContent = "‚ùå getStatus: " + j.error; return; }

      renderStatus(j);

      if (j && j.previews) {
        ["vin","corr_pre","corr_post","voltaje","scan_carro"].forEach(slot => {
          const p = j.previews[slot];
          if (p) setRemotePreview(slot, p);
        });

        ["comp_1","comp_2","comp_3","comp_4"].forEach((slot, i) => {
          const p = j.previews[slot];
          if (p) setRemoteCompPreview(i + 1, p);
        });
      }
    }

    $("btnRefresh").onclick = refreshStatus;
    $("vinText").addEventListener("change", refreshStatus);
    $("dateStr").addEventListener("change", refreshStatus);

    // ====== COMPRESI√ìN/REDIMENSION ANTES DE BASE64 ======
    async function fileToB64Compressed(file){
      if (!file) return "";

      if (!/^image\//i.test(file.type || "")) {
        return await new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onload = () => resolve(String(r.result).split(",")[1] || "");
          r.onerror = reject;
          r.readAsDataURL(file);
        });
      }

      const imgURL = URL.createObjectURL(file);
      try {
        const img = await new Promise((resolve, reject) => {
          const im = new Image();
          im.onload = () => resolve(im);
          im.onerror = reject;
          im.src = imgURL;
        });

        const maxW = 1280;
        const quality = 0.75;
        let w = img.naturalWidth || img.width;
        let h = img.naturalHeight || img.height;

        if (w > maxW) {
          const scale = maxW / w;
          w = Math.round(w * scale);
          h = Math.round(h * scale);
        }

        const canvas = document.createElement("canvas");
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, w, h);

        const dataUrl = canvas.toDataURL("image/jpeg", quality);
        return dataUrl.split(",")[1] || "";
      } finally {
        URL.revokeObjectURL(imgURL);
      }
    }

    // ====== UPLOAD ======
    $("btnUpload").onclick = async () => {
      const vin = $("vinText").value.trim();
      const dateStr = ($("dateStr").value || todayYYYYMMDD());
      if (!vin) { $("out").textContent = "‚ùå Falta VIN (texto)."; return; }

      const files = [];

      const singleSlots = ["vin","corr_pre","corr_post","voltaje","scan_carro"];
      for (const slot of singleSlots){
        const f = selectedFilesBySlot[slot];
        if (f) {
          $("out").textContent = `Preparando ${slot}...\n`;
          const b64 = await fileToB64Compressed(f);
          files.push({ slot, mimeType: "image/jpeg", b64 });
        }
      }

      for (let i = 0; i < 4; i++){
        const f = compFilesVisual[i];
        if (!f) continue;
        const slot = `comp_${i+1}`;
        $("out").textContent = `Preparando ${slot}...\n`;
        const b64 = await fileToB64Compressed(f);
        files.push({ slot, mimeType: "image/jpeg", b64 });
      }

      if (files.length === 0) {
        $("out").textContent = "‚ö†Ô∏è No seleccionaste ninguna foto para subir.";
        await refreshStatus();
        return;
      }

      $("out").textContent = `Subiendo ${files.length} foto(s)...\n`;
      const j = await callAPS({ action: "uploadFiles", vin, dateStr, files });
      if (!j.ok) { $("out").textContent = "‚ùå uploadFiles: " + j.error; return; }

      $("out").textContent = "‚úÖ Subido.\nRefrescando estado...\n";

      for (const slot of Object.keys(selectedFilesBySlot)) {
        delete selectedFilesBySlot[slot];
        setPreview(slot, null);
        const cam = $(`${slot}_cam`);
        const file = $(`${slot}_file`);
        if (cam) cam.value = "";
        if (file) file.value = "";
      }
      clearComp();

      await refreshStatus();
    };

    // ====== BOTONES TOMAR/SUBIR/QUITAR ======
    document.addEventListener("click", (ev) => {
      const btn = ev.target.closest("button");
      if (!btn) return;

      const slot = btn.getAttribute("data-slot");
      if (!slot) return;

      if (btn.getAttribute("data-pick") === "cam") {
        if (slot === "comp") $("comp_cam").click();
        else $(`${slot}_cam`).click();
      }
      if (btn.getAttribute("data-pick") === "file") {
        if (slot === "comp") $("comp_file").click();
        else $(`${slot}_file`).click();
      }
      if (btn.getAttribute("data-clear") === "1") {
        if (slot === "comp") clearComp();
        else {
          delete selectedFilesBySlot[slot];
          setPreview(slot, null);
          const cam = $(`${slot}_cam`);
          const file = $(`${slot}_file`);
          if (cam) cam.value = "";
          if (file) file.value = "";
        }
      }
    });

    // ====== INPUTS NORMALES ======
    function wireInput(slot){
      const cam = $(`${slot}_cam`);
      const fil = $(`${slot}_file`);

      const onPick = (e) => {
        const f = e.target && e.target.files && e.target.files[0];
        if (!f) return;
        selectedFilesBySlot[slot] = f;
        setPreview(slot, f);
      };

      if (cam) cam.addEventListener("change", onPick);
      if (fil) fil.addEventListener("change", onPick);
      setPreview(slot, null);
    }
    ["vin","corr_pre","corr_post","voltaje","scan_carro"].forEach(wireInput);

    // =========================================================
    // ‚úÖ 3 SCANNERS INDEPENDIENTES (PARAMS / FALLA / CALIDAD)
    // =========================================================
    let qrParams = null;
    let qrFalla  = null;
    let qrQc     = null;

    function normalizeScanText(t){
      return String(t || "").replace(/\s+/g, "").trim();
    }

    async function stopScanner(which){
      const map = {
        params: { inst: () => qrParams, box:"qrBox_params", stop:"btnStop_params", mode:"scanMode_params" },
        falla:  { inst: () => qrFalla,  box:"qrBox_falla",  stop:"btnStop_falla",  mode:"scanMode_falla"  },
        qc:     { inst: () => qrQc,     box:"qrBox_qc",     stop:"btnStop_qc",     mode:"scanMode_qc"     }
      };

      const m = map[which];
      if (!m) return;

      const inst = m.inst();
      if (inst) { try { await inst.stop(); } catch {} }

      const boxEl  = $(m.box);  if (boxEl) boxEl.style.display = "none";
      const stopEl = $(m.stop); if (stopEl) stopEl.style.display = "none";
      const modeEl = $(m.mode); if (modeEl) modeEl.textContent = "";
    }

    async function stopAllScanners(){
      await stopScanner("params");
      await stopScanner("falla");
      await stopScanner("qc");
    }

    async function startScanner(which, mode){
      await stopScanner(which);

      const cfg = {
        params: { readerId:"qrReader_params", box:"qrBox_params", stop:"btnStop_params", msg:"scanMsg_params", mode:"scanMode_params",
                  setVin:(v)=>{$("vinText").value=v; refreshStatus();}, getInst:()=>qrParams, setInst:(v)=>qrParams=v },
        falla:  { readerId:"qrReader_falla",  box:"qrBox_falla",  stop:"btnStop_falla",  msg:"scanMsg_falla",  mode:"scanMode_falla",
                  setVin:(v)=>{$("fallaVin").value=v;}, getInst:()=>qrFalla,  setInst:(v)=>qrFalla=v  },
        qc:     { readerId:"qrReader_qc",     box:"qrBox_qc",     stop:"btnStop_qc",     msg:"scanMsg_qc",     mode:"scanMode_qc",
                  setVin:(v)=>{$("qcVin").value=v;}, getInst:()=>qrQc,     setInst:(v)=>qrQc=v     }
      };

      const c = cfg[which];
      if (!c) return;

      $(c.box).style.display = "block";
      $(c.stop).style.display = "inline-block";
      $(c.msg).textContent = "";
      $(c.mode).textContent = (mode === "QR") ? "Modo: SOLO QR" : "Modo: SOLO BARRAS (CODE_128 y otros)";

      if (!c.getInst()) c.setInst(new Html5Qrcode(c.readerId));

      const formats = (mode === "QR")
        ? [ Html5QrcodeSupportedFormats.QR_CODE ]
        : [
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.CODE_39,
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.EAN_8,
            Html5QrcodeSupportedFormats.UPC_A,
            Html5QrcodeSupportedFormats.UPC_E,
            Html5QrcodeSupportedFormats.ITF,
            Html5QrcodeSupportedFormats.CODABAR
          ];

      const scanConfig = (mode === "QR")
        ? { fps: 12, qrbox: { width: 280, height: 280 }, formatsToSupport: formats }
        : { fps: 12, qrbox: { width: 200, height: 360 }, formatsToSupport: formats };

      try {
        await c.getInst().start(
          { facingMode: "environment" },
          scanConfig,
          (decodedText) => {
            const val = normalizeScanText(decodedText);
            if (!val) return;

            c.setVin(val);
            $(c.msg).textContent = `Detectado (${mode === "QR" ? "QR" : "BARRAS"}): ${val}`;
            stopScanner(which);
          },
          () => {}
        );
      } catch (e) {
        $(c.msg).textContent = `Error c√°mara (${mode}): ${e}`;
      }
    }

    $("btnScanQR_params").onclick  = () => startScanner("params","QR");
    $("btnScanBAR_params").onclick = () => startScanner("params","BAR");
    $("btnStop_params").onclick    = () => stopScanner("params");

    $("btnScanQR_falla").onclick   = () => startScanner("falla","QR");
    $("btnScanBAR_falla").onclick  = () => startScanner("falla","BAR");
    $("btnStop_falla").onclick     = () => stopScanner("falla");

    $("btnScanQR_qc").onclick      = () => startScanner("qc","QR");
    $("btnScanBAR_qc").onclick     = () => startScanner("qc","BAR");
    $("btnStop_qc").onclick        = () => stopScanner("qc");

    // =========================
    // FALLAS: lista din√°mica
    // =========================
    let fallaFiles = [];

    function renderFalla(){
      const grid = $("fallaGrid");
      if (!grid) return;

      grid.innerHTML = "";

      fallaFiles.forEach((f, idx) => {
        const url = URL.createObjectURL(f);

        const wrap = document.createElement("div");
        wrap.style.position = "relative";

        const thumb = document.createElement("div");
        thumb.className = "thumb";
        thumb.innerHTML = `<img alt="falla" src="${url}">`;
        wrap.appendChild(thumb);

        const x = document.createElement("button");
        x.type = "button";
        x.textContent = "‚úñ";
        x.className = "btn3";
        x.style.position = "absolute";
        x.style.top = "6px";
        x.style.right = "6px";
        x.style.padding = "4px 8px";
        x.style.borderRadius = "10px";
        x.onclick = () => {
          fallaFiles.splice(idx, 1);
          renderFalla();
        };
        wrap.appendChild(x);

        grid.appendChild(wrap);

        setTimeout(() => URL.revokeObjectURL(url), 15000);
      });

      const total = fallaFiles.reduce((a,f)=>a+(f.size||0),0);
      $("fallaFotosMeta").textContent = `${fallaFiles.length} archivo(s) ‚Ä¢ ${humanBytes(total)}`;
    }

    function addFallaFiles(fileList){
      const arr = Array.from(fileList || []);
      if (!arr.length) return;
      fallaFiles.push(...arr);
      renderFalla();
    }

    $("btnFallaCam").onclick   = () => $("falla_cam").click();
    $("btnFallaFile").onclick  = () => $("falla_file").click();
    $("btnFallaClear").onclick = () => { fallaFiles = []; renderFalla(); };

    $("falla_cam").addEventListener("change", (e) => { addFallaFiles(e.target.files); e.target.value = ""; });
    $("falla_file").addEventListener("change", (e) => { addFallaFiles(e.target.files); e.target.value = ""; });

    renderFalla();

    $("btnEnviarFalla").onclick = async () => {
      const vin = $("fallaVin").value.trim();
      const dateStr = ($("fallaDate").value || todayYYYYMMDD());
      const note = ($("fallaNota").value || "").trim();

      if (!vin) { $("outFalla").textContent = "‚ùå Falta VIN."; return; }
      if (!note && fallaFiles.length === 0) { $("outFalla").textContent = "‚ö†Ô∏è Agrega una nota o al menos una foto."; return; }

      $("outFalla").textContent = `Preparando ${fallaFiles.length} foto(s)...\n`;

      const files = [];
      for (let i = 0; i < fallaFiles.length; i++){
        $("outFalla").textContent = `Preparando foto ${i+1}/${fallaFiles.length}...\n`;
        const b64 = await fileToB64Compressed(fallaFiles[i]);
        files.push({ slot: "falla", mimeType: "image/jpeg", b64 });
      }

      $("outFalla").textContent = `Subiendo FALLA (${files.length} foto(s) + nota)...\n`;
      const j = await callAPS({ action: "uploadFalla", vin, dateStr, note, files });
      if (!j.ok) { $("outFalla").textContent = "‚ùå uploadFalla: " + j.error; return; }

      $("outFalla").textContent =
        `‚úÖ Falla registrada.\n` +
        `Carpeta: ${j.carFolderName}/FALLAS\n` +
        `Batch: ${j.batchId}\n` +
        `Guardados: ${j.savedCount}`;

      fallaFiles = [];
      renderFalla();
    };

    // =========================
    // CONTROL CALIDAD (3 a 4 fotos)
    // =========================

    // =========================
// ‚úÖ CONTROL CALIDAD (m√≠n 3, m√°x 4) + MULTI-SELECT + LIGHTBOX OK
// =========================
let qcFiles = [null, null, null, null];

(function initQcDate(){
  const qcDate = $("qcDate");
  if (qcDate) qcDate.value = todayYYYYMMDD();
})();

function clearQc(){
  qcFiles = [null, null, null, null];
  ["qc_p1","qc_p2","qc_p3","qc_p4"].forEach((id, idx) => {
    const box = $(id);
    if (box) box.innerHTML = `<span class="small">${idx+1}</span>`;
  });
  if ($("qc_meta")) $("qc_meta").textContent = "0/4 seleccionadas.";
  if ($("qc_cam")) $("qc_cam").value = "";
  if ($("qc_file")) $("qc_file").value = "";
}

function renderQc(){
  const ids = ["qc_p1","qc_p2","qc_p3","qc_p4"];
  ids.forEach((id, idx) => {
    const box = $(id);
    if (!box) return;

    const f = qcFiles[idx];
    if (!f){
      box.innerHTML = `<span class="small">${idx+1}</span>`;
      return;
    }

    const url = URL.createObjectURL(f);
    box.innerHTML = `<img alt="qc" src="${url}">`;
    setTimeout(() => URL.revokeObjectURL(url), 15000);
  });

  const chosen = qcFiles.filter(Boolean);
  const total = chosen.reduce((a,f)=>a+(f.size||0),0);
  if ($("qc_meta")) $("qc_meta").textContent =
    `${chosen.length}/4 seleccionadas ‚Ä¢ ${humanBytes(total)} (m√≠n 3)`;
}

// mete al final y ‚Äúempuja atr√°s‚Äù (igual que compresi√≥n)
function addQcOne(file){
  if (!file) return;
  qcFiles[0] = qcFiles[1];
  qcFiles[1] = qcFiles[2];
  qcFiles[2] = qcFiles[3];
  qcFiles[3] = file;
  renderQc();
}

// üì∑ C√°mara: 1 foto
function onPickQcCam(fileList){
  const f = (fileList && fileList[0]) ? fileList[0] : null;
  if (!f) return;
  addQcOne(f);
  $("qc_cam").value = "";
}

// üñºÔ∏è Archivos: VARIAS fotos a la vez (se queda con las √∫ltimas 4)
function onPickQcFiles(fileList){
  const arr = Array.from(fileList || []);
  if (!arr.length) return;

  const take = arr.slice(-4);
  for (const f of take) addQcOne(f);

  $("qc_file").value = "";
}

// botones
$("btnQcCam").onclick   = () => $("qc_cam").click();
$("btnQcFile").onclick  = () => $("qc_file").click();
$("btnQcClear").onclick = clearQc;

// listeners
$("qc_cam").addEventListener("change", (e) => onPickQcCam(e.target.files));
$("qc_file").addEventListener("change", (e) => onPickQcFiles(e.target.files));

clearQc();

// ‚úÖ ENVIAR CALIDAD (usa tu action uploadCalidad)
$("btnQcUpload").onclick = async () => {
  const vin = $("qcVin").value.trim();
  const dateStr = ($("qcDate").value || todayYYYYMMDD());
  if (!vin) { $("outQc").textContent = "‚ùå Falta VIN."; return; }

  const chosen = qcFiles.filter(Boolean);
  if (chosen.length < 3) { $("outQc").textContent = "‚ö†Ô∏è Debes subir m√≠nimo 3 fotos de calidad."; return; }

  const files = [];
  for (let i = 0; i < 4; i++){
    const f = qcFiles[i];
    if (!f) continue;
    const slot = `calidad_${i+1}`;
    $("outQc").textContent = `Preparando ${slot}...\n`;
    const b64 = await fileToB64Compressed(f);
    files.push({ slot, mimeType: "image/jpeg", b64 });
  }

  if (files.length === 0) {
    $("outQc").textContent = "‚ö†Ô∏è No seleccionaste fotos para calidad.";
    return;
  }

  $("outQc").textContent = `Enviando CALIDAD (${files.length} foto(s))...\n`;
  const j = await callAPS({ action: "uploadCalidad", vin, dateStr, files });
  if (!j.ok) { $("outQc").textContent = "‚ùå uploadCalidad: " + j.error; return; }

  $("outQc").textContent =
    `‚úÖ Calidad registrada.\n` +
    `Carpeta: ${j.carFolderName}/CALIDAD\n` +
    `Guardados: ${(j.saved && j.saved.length) ? j.saved.length : files.length}`;

  clearQc();
};


  </script>

</body>
</html>
