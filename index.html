<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>Uploader GLP</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; padding: 16px; max-width: 760px; margin: 0 auto; }
    .row { margin: 10px 0; }
    .box { border: 1px solid #ddd; padding: 12px; border-radius: 10px; margin: 10px 0; }
    label { display:block; font-weight:600; margin-bottom:6px; }
    input[type="text"], input[type="date"] { width: 100%; padding: 10px; border: 1px solid #bbb; border-radius: 10px; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; }
    .btn { background: #0b5fff; color: white; }
    .btn2 { background: #111; color: white; }
    .btn3 { background: #eee; color: #111; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .small { color: #555; font-size: 12px; }
    .status { white-space: pre-wrap; background: #f6f6f6; padding: 12px; border-radius: 10px; }
    #qrReader { width: 100%; }

    /* ---- uploader widgets ---- */
    .slotCard{ border:1px solid #e5e5e5; border-radius:12px; padding:12px; background:#fff; }
    .slotActions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .slotActions button{ padding:8px 10px; border-radius:10px; font-size:14px; }
    .mini{ margin-top:10px; display:flex; gap:10px; align-items:center; }
    .thumb{
      width:84px; height:84px; border-radius:12px; border:1px solid #ddd;
      background:#fafafa; display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .miniInfo{ font-size:12px; color:#444; }
    .hiddenInput{ display:none; }
  </style>
</head>
<body>

  <h2>Subida por VIN (Colaborativo)</h2>

  <div class="box">
    <div class="row">
      <button class="btn" id="btnScan">Escanear QR / Barra</button>
      <button class="btn3" id="btnStop" style="display:none;">Detener</button>
      <div class="small" id="scanMsg"></div>
    </div>

    <div id="qrBox" style="display:none; margin-top:10px;">
      <div id="qrReader"></div>
    </div>

    <div class="row">
      <label>VIN (texto)</label>
      <input id="vinText" type="text" placeholder="Escanea o escribe VIN..." />
    </div>

    <div class="row">
      <label>Fecha (YYYY-MM-DD)</label>
      <input id="dateStr" type="date" />
      <div class="small">Si no eliges fecha, usa la de hoy.</div>
    </div>

    <div class="row">
      <button class="btn3" id="btnRefresh">Refrescar estado</button>
    </div>
  </div>

  <h3>Fotos (9) ‚Äî se guardan en Drive</h3>

  <div class="box grid">

    <!-- SLOT TEMPLATE (cada slot tiene: input c√°mara + input archivo + preview) -->

    <div class="slotCard" data-slot="vin">
      <label>1) Foto del VIN</label>

      <!-- inputs ocultos -->
      <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" capture="environment" id="vin_cam">
      <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" id="vin_file">

      <div class="slotActions">
        <button class="btn3" type="button" data-pick="cam" data-slot="vin">üì∑ Tomar foto</button>
        <button class="btn3" type="button" data-pick="file" data-slot="vin">üñºÔ∏è Subir archivo</button>
        <button class="btn3" type="button" data-clear="1" data-slot="vin">üßπ Quitar</button>
      </div>

      <div class="mini">
        <div class="thumb" id="vin_previewBox"><span class="small">Sin foto</span></div>
        <div class="miniInfo" id="vin_meta">Ning√∫n archivo seleccionado.</div>
      </div>
    </div>

    <div class="slotCard">
      <label>2) Compresi√≥n (4 fotos)</label>
    
      <div class="grid" style="grid-template-columns: 1fr; gap:12px;">
    
        <!-- COMP 1 -->
        <div class="box" style="margin:0; padding:10px;">
          <div class="small"><b>Compresi√≥n 1</b></div>
          <input class="hiddenInput" type="file" accept="image/*;capture=camera" capture="environment" id="comp_1_cam">
          <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" id="comp_1_file">
    
          <div class="slotActions">
            <button class="btn3" type="button" data-pick="cam" data-slot="comp_1">üì∑ Tomar foto</button>
            <button class="btn3" type="button" data-pick="file" data-slot="comp_1">üñºÔ∏è Subir archivo</button>
            <button class="btn3" type="button" data-clear="1" data-slot="comp_1">üßπ Quitar</button>
          </div>
    
          <div class="mini">
            <div class="thumb" id="comp_1_previewBox"><span class="small">Sin foto</span></div>
            <div class="miniInfo" id="comp_1_meta">Ning√∫n archivo seleccionado.</div>
          </div>
        </div>
    
        <!-- COMP 2 -->
        <div class="box" style="margin:0; padding:10px;">
          <div class="small"><b>Compresi√≥n 2</b></div>
          <input class="hiddenInput" type="file" accept="image/*;capture=camera" capture="environment" id="comp_2_cam">
          <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" id="comp_2_file">
    
          <div class="slotActions">
            <button class="btn3" type="button" data-pick="cam" data-slot="comp_2">üì∑ Tomar foto</button>
            <button class="btn3" type="button" data-pick="file" data-slot="comp_2">üñºÔ∏è Subir archivo</button>
            <button class="btn3" type="button" data-clear="1" data-slot="comp_2">üßπ Quitar</button>
          </div>
    
          <div class="mini">
            <div class="thumb" id="comp_2_previewBox"><span class="small">Sin foto</span></div>
            <div class="miniInfo" id="comp_2_meta">Ning√∫n archivo seleccionado.</div>
          </div>
        </div>
    
        <!-- COMP 3 -->
        <div class="box" style="margin:0; padding:10px;">
          <div class="small"><b>Compresi√≥n 3</b></div>
          <input class="hiddenInput" type="file" accept="image/*;capture=camera" capture="environment" id="comp_3_cam">
          <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" id="comp_3_file">
    
          <div class="slotActions">
            <button class="btn3" type="button" data-pick="cam" data-slot="comp_3">üì∑ Tomar foto</button>
            <button class="btn3" type="button" data-pick="file" data-slot="comp_3">üñºÔ∏è Subir archivo</button>
            <button class="btn3" type="button" data-clear="1" data-slot="comp_3">üßπ Quitar</button>
          </div>
    
          <div class="mini">
            <div class="thumb" id="comp_3_previewBox"><span class="small">Sin foto</span></div>
            <div class="miniInfo" id="comp_3_meta">Ning√∫n archivo seleccionado.</div>
          </div>
        </div>
    
        <!-- COMP 4 -->
        <div class="box" style="margin:0; padding:10px;">
          <div class="small"><b>Compresi√≥n 4</b></div>
          <input class="hiddenInput" type="file" accept="image/*;capture=camera" capture="environment" id="comp_4_cam">
          <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" id="comp_4_file">
    
          <div class="slotActions">
            <button class="btn3" type="button" data-pick="cam" data-slot="comp_4">üì∑ Tomar foto</button>
            <button class="btn3" type="button" data-pick="file" data-slot="comp_4">üñºÔ∏è Subir archivo</button>
            <button class="btn3" type="button" data-clear="1" data-slot="comp_4">üßπ Quitar</button>
          </div>
    
          <div class="mini">
            <div class="thumb" id="comp_4_previewBox"><span class="small">Sin foto</span></div>
            <div class="miniInfo" id="comp_4_meta">Ning√∫n archivo seleccionado.</div>
          </div>
        </div>
    
      </div>
    </div>





    <div class="slotCard" data-slot="corr_pre">
      <label>6) Corriente antes</label>

      <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" capture="environment" id="corr_pre_cam">
      <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" id="corr_pre_file">

      <div class="slotActions">
        <button class="btn3" type="button" data-pick="cam" data-slot="corr_pre">üì∑ Tomar foto</button>
        <button class="btn3" type="button" data-pick="file" data-slot="corr_pre">üñºÔ∏è Subir archivo</button>
        <button class="btn3" type="button" data-clear="1" data-slot="corr_pre">üßπ Quitar</button>
      </div>

      <div class="mini">
        <div class="thumb" id="corr_pre_previewBox"><span class="small">Sin foto</span></div>
        <div class="miniInfo" id="corr_pre_meta">Ning√∫n archivo seleccionado.</div>
      </div>
    </div>

    <div class="slotCard" data-slot="corr_post">
      <label>7) Corriente despu√©s</label>

      <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" capture="environment" id="corr_post_cam">
      <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" id="corr_post_file">

      <div class="slotActions">
        <button class="btn3" type="button" data-pick="cam" data-slot="corr_post">üì∑ Tomar foto</button>
        <button class="btn3" type="button" data-pick="file" data-slot="corr_post">üñºÔ∏è Subir archivo</button>
        <button class="btn3" type="button" data-clear="1" data-slot="corr_post">üßπ Quitar</button>
      </div>

      <div class="mini">
        <div class="thumb" id="corr_post_previewBox"><span class="small">Sin foto</span></div>
        <div class="miniInfo" id="corr_post_meta">Ning√∫n archivo seleccionado.</div>
      </div>
    </div>

    <div class="slotCard" data-slot="voltaje">
      <label>8) Voltaje</label>

      <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" capture="environment" id="voltaje_cam">
      <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" id="voltaje_file">

      <div class="slotActions">
        <button class="btn3" type="button" data-pick="cam" data-slot="voltaje">üì∑ Tomar foto</button>
        <button class="btn3" type="button" data-pick="file" data-slot="voltaje">üñºÔ∏è Subir archivo</button>
        <button class="btn3" type="button" data-clear="1" data-slot="voltaje">üßπ Quitar</button>
      </div>

      <div class="mini">
        <div class="thumb" id="voltaje_previewBox"><span class="small">Sin foto</span></div>
        <div class="miniInfo" id="voltaje_meta">Ning√∫n archivo seleccionado.</div>
      </div>
    </div>

    <div class="slotCard" data-slot="scan_carro">
      <label>9) Scan del carro</label>

      <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" capture="environment" id="scan_carro_cam">
      <input class="hiddenInput" type="file" accept="image/*,.heic,.heif" id="scan_carro_file">

      <div class="slotActions">
        <button class="btn3" type="button" data-pick="cam" data-slot="scan_carro">üì∑ Tomar foto</button>
        <button class="btn3" type="button" data-pick="file" data-slot="scan_carro">üñºÔ∏è Subir archivo</button>
        <button class="btn3" type="button" data-clear="1" data-slot="scan_carro">üßπ Quitar</button>
      </div>

      <div class="mini">
        <div class="thumb" id="scan_carro_previewBox"><span class="small">Sin foto</span></div>
        <div class="miniInfo" id="scan_carro_meta">Ning√∫n archivo seleccionado.</div>
      </div>
    </div>

  </div>

  <div class="row">
    <button class="btn2" id="btnUpload">SUBIR FOTOS SELECCIONADAS A DRIVE</button>
  </div>

  <h3>Estado colaborativo</h3>
  <div id="out" class="status">Listo.</div>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    // ‚úÖ TU URL DEL APPS SCRIPT (termina en /exec)
    const APS_URL = "https://script.google.com/macros/s/AKfycbw8WdoYVKGU9ztmHv81c-GzcUxpaCdMn5mvk5XgqJQ7kicbivdr6DFRIgTEOq_nIUMV/exec";

    const $ = (id) => document.getElementById(id);

    const slots = [
      "vin",
      "comp_1","comp_2","comp_3","comp_4",
      "corr_pre","corr_post",
      "voltaje",
      "scan_carro"
    ];

    const slotLabels = {
      vin: "Foto del VIN",
      comp_1: "Compresi√≥n 1",
      comp_2: "Compresi√≥n 2",
      comp_3: "Compresi√≥n 3",
      comp_4: "Compresi√≥n 4",
      corr_pre: "Corriente antes",
      corr_post: "Corriente despu√©s",
      voltaje: "Voltaje",
      scan_carro: "Scan del carro",
    };;

    // guardamos el archivo elegido por slot (viene de cam o file)
    const selectedFilesBySlot = {};

    function todayYYYYMMDD() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    // date input: set default to today
    (function initDate(){
      $("dateStr").value = todayYYYYMMDD();
    })();

    async function callAPS(payload){
      const res = await fetch(APS_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });
      return res.json();
    }

    function humanBytes(n){
      const u = ["B","KB","MB","GB"];
      let i=0, v=n;
      while(v>=1024 && i<u.length-1){ v/=1024; i++; }
      return `${v.toFixed(i===0?0:1)} ${u[i]}`;
    }

    function setPreview(slot, file){
      const box = $(`${slot}_previewBox`);
      const meta = $(`${slot}_meta`);

      if (!file){
        box.innerHTML = `<span class="small">Sin foto</span>`;
        meta.textContent = "Ning√∫n archivo seleccionado.";
        return;
      }

      meta.textContent = `${file.name || "(foto)"} ‚Ä¢ ${humanBytes(file.size || 0)}`;

      const url = URL.createObjectURL(file);
      box.innerHTML = `<img alt="preview" src="${url}">`;
      // liberar luego (pero mantenemos un poquito para no parpadear)
      setTimeout(() => URL.revokeObjectURL(url), 15000);
    }
    
    function renderStatus(j){
      let s = "";
      s += `VIN: ${j.vin}\n`;
      s += `Fecha: ${j.dateStr}\n`;
      s += `Carpeta: ${j.monthFolderName} / ${j.carFolderName} / REGISTRO\n\n`;
    
      // --- Agrupar compresi√≥n ---
      const compSlots = ["comp_1","comp_2","comp_3","comp_4"];
      const compOkCount = compSlots.filter(sl => j.status && j.status[sl]).length;
      const compMissing = compSlots.filter(sl => !(j.status && j.status[sl])).map(sl => slotLabels[sl]);
    
      s += `${compOkCount === 4 ? "‚úÖ" : "‚ùå"} Compresi√≥n (${compOkCount}/4)\n`;
      if (compMissing.length) {
        s += `   Faltan: ${compMissing.join(", ")}\n`;
      }
    
      // --- Resto de slots (sin repetir comp_1..4) ---
      const otherSlots = ["vin","corr_pre","corr_post","voltaje","scan_carro"];
      let missing = [];
    
      for (const slot of otherSlots){
        const ok = j.status && j.status[slot];
        const p = j.previews && j.previews[slot];
        s += `${ok ? "‚úÖ" : "‚ùå"} ${slotLabels[slot]}`;
        if (p && p.url) s += `  (ver: ${p.url})`;
        s += "\n";
        if (!ok) missing.push(slotLabels[slot]);
      }
    
      // faltantes incluye tambi√©n compresi√≥n
      const allMissing = [...(compMissing.length ? compMissing : []), ...missing];
      s += `\nFaltantes (${allMissing.length}/9):\n- ` + (allMissing.length ? allMissing.join("\n- ") : "Ninguno üéâ");
    
      $("out").textContent = s;
    }

    async function refreshStatus(){
      const vin = $("vinText").value.trim();
      const dateStr = ($("dateStr").value || todayYYYYMMDD());
      if (!vin) { $("out").textContent = "‚ùå Falta VIN (texto)."; return; }

      const j = await callAPS({ action: "getStatus", vin, dateStr });
      if (!j.ok) { $("out").textContent = "‚ùå getStatus: " + j.error; return; }
      renderStatus(j);
    }

    $("btnRefresh").onclick = refreshStatus;
    $("vinText").addEventListener("change", refreshStatus);
    $("dateStr").addEventListener("change", refreshStatus);

    function fileToB64(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => {
          const b64 = String(r.result).split(",")[1] || "";
          resolve(b64);
        };
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    // ‚úÖ Subir solo las fotos seleccionadas (por partes)
    $("btnUpload").onclick = async () => {
      const vin = $("vinText").value.trim();
      const dateStr = ($("dateStr").value || todayYYYYMMDD());
      if (!vin) { $("out").textContent = "‚ùå Falta VIN (texto)."; return; }

      const files = [];
      for (const slot of slots){
        const f = selectedFilesBySlot[slot];
        if (f) {
          const b64 = await fileToB64(f);
          files.push({ slot, mimeType: f.type || "image/jpeg", b64 });
        }
      }

      if (files.length === 0) {
        $("out").textContent = "‚ö†Ô∏è No seleccionaste ninguna foto para subir.";
        await refreshStatus();
        return;
      }

      $("out").textContent = `Subiendo ${files.length} foto(s)...\n`;
      const j = await callAPS({ action: "uploadFiles", vin, dateStr, files });
      if (!j.ok) { $("out").textContent = "‚ùå uploadFiles: " + j.error; return; }

      $("out").textContent = "‚úÖ Subido.\nRefrescando estado...\n";

      // limpiar selecci√≥n local despu√©s de subir (opcional)
      for (const slot of Object.keys(selectedFilesBySlot)) {
        delete selectedFilesBySlot[slot];
        setPreview(slot, null);
        // reset inputs para poder elegir el mismo archivo de nuevo si quieren
        const cam = $(`${slot}_cam`);
        const file = $(`${slot}_file`);
        if (cam) cam.value = "";
        if (file) file.value = "";
      }

      await refreshStatus();
    };

    // ‚úÖ Manejo de botones "Tomar foto / Subir archivo / Quitar"
    document.addEventListener("click", (ev) => {
      const btn = ev.target.closest("button");
      if (!btn) return;

      const slot = btn.getAttribute("data-slot");
      if (!slot) return;

      if (btn.getAttribute("data-pick") === "cam") {
        $(`${slot}_cam`).click();
      }
      if (btn.getAttribute("data-pick") === "file") {
        $(`${slot}_file`).click();
      }
      if (btn.getAttribute("data-clear") === "1") {
        delete selectedFilesBySlot[slot];
        setPreview(slot, null);
        const cam = $(`${slot}_cam`); const file = $(`${slot}_file`);
        if (cam) cam.value = "";
        if (file) file.value = "";
      }
    });

    // ‚úÖ Cuando cambia input (cam o file), guardamos y previsualizamos
    function wireInput(slot){
      const cam = $(`${slot}_cam`);
      const fil = $(`${slot}_file`);

      const onPick = (e) => {
        const f = e.target && e.target.files && e.target.files[0];
        if (!f) return;
        selectedFilesBySlot[slot] = f;
        setPreview(slot, f);
      };

      if (cam) cam.addEventListener("change", onPick);
      if (fil) fil.addEventListener("change", onPick);

      // init empty preview
      setPreview(slot, null);
    }

    slots.forEach(wireInput);

    // ===== Scanner (QR / Barra) =====
    let qr = null;

    async function startScan(){
      $("qrBox").style.display = "block";
      $("btnStop").style.display = "inline-block";
      $("scanMsg").textContent = "";

      if (!qr) qr = new Html5Qrcode("qrReader");
      const config = { fps: 10, qrbox: { width: 280, height: 180 } };

      try {
        await qr.start(
          { facingMode: "environment" },
          config,
          (decodedText) => {
            $("vinText").value = (decodedText || "").trim();
            $("scanMsg").textContent = "Detectado: " + decodedText;
            refreshStatus();
          },
          () => {}
        );
      } catch (e) {
        $("scanMsg").textContent = "Error c√°mara: " + e;
      }
    }

    async function stopScan(){
      if (qr) { try { await qr.stop(); } catch {} }
      $("qrBox").style.display = "none";
      $("btnStop").style.display = "none";
    }

    $("btnScan").onclick = startScan;
    $("btnStop").onclick = stopScan;
  </script>

</body>
</html>
